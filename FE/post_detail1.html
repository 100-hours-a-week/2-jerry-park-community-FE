<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/> 
    <title> 게시글 상세조회 </title>
    <link rel="stylesheet" href = "post_detail.css">  <!--외부 css 파일 연결-->
</head>

<body>
    <div class = "header">
        <a href="postlist.html"><</a>
        <h1> 아무 말 대잔치 </h1>  <!--아무말 대잔치 레이아웃-->
        
        <img class="image1" src="profile_img.webp"/>
    </div>

    <section class="wrap">
        <article>
            <div class = "title" > <h1 id = "title"> 제목 로딩 .. posts.json 해당 postid의 제목</h1></div>
            <div class = "userinfo">
                <img class="image2" src="profile_img.webp"/>
                <p id = "author"> 작성자 로딩.. </p>
                <p1 id = "date"> 날짜 로딩... </p1>
                <div class ="editdel">
                    <button id= "posteditButton">수정</button>
                    <button onclick="openModal('delete')">삭제</button>
                </div>
            </div>
            <hr class="topofphoto">
            <div class = "content">
                <img class="image3" src="profile_img.webp"/>
                <p id = "content"> 내용 로딩 .. </p>
            </div>  
            <div class = "gaechu">
                <div class="gaechu1"> 
                    <span class="likesu" id = "likes">123</span> <span class="su">좋아요수</span></div>
                <div class="gaechu1"> 
                    <span class="likesu" id = "views">123</span><span class="su">조회수</span></div>
                <div class="gaechu1"> 
                    <span class="likesu" id = "comments">123</span><span class="su">댓글</span></div>
            </div>  
            <hr class="normalhr">
            <div class = "commentBox">
                <textarea type="text" name="comment" id="comment" placeholder="댓글을 남겨주세요!"></textarea> 
            </div>
            <hr class = "normalhr">

            <div class ="commentUp">
                <button id="commentUp" onclick="commentUp()">댓글 등록</button>
            </div>

            <div class = "allcommentBox">
                
                <div class = "commentInfo">
                    <!-- <div class ="comments">
                        <img class="image4" src="profile_img.webp"/>
                        <div class="author" id = "commentauthor">더미 작성자 1 </div>
                        <div class="date" id ="commentdate">2021-01-01 00:00:00</div>
                        
                    </div>
                    <div class="commentcontent" id = "commentcontent">
                        댓글 내용
                    </div> -->
                    
                </div>
                <div class = "editdelete">
                    <div class="editdelB">
                        <button onclick="" >수정</button> <!--수정기능 필요-->
                        <button onclick="openCommentDeleteModal('delete')">삭제</button>
                    </div>
                </div>
            </div>
            <!-- <div class = "allcommentBox">
                <div class = "commentInfo">
                    <div class ="comments">
                        <img class="image4" src="profile_img.webp"/>
                        <div class="author">더미 작성자 1 </div>
                        <div class="date">2021-01-01 00:00:00</div>
                        
                    </div>
                    <div class="commentcontent">
                        댓글 내용
                    </div>
                    
                </div>
                <div class = "editdelete">
                    <div class="editdelB">
                        <button onclick="openModal('edit')">수정</button>
                        <button onclick="openModal('delete')">삭제</button>
                    </div>
                </div>
            </div>
            <div class = "allcommentBox">
                <div class = "commentInfo">
                    <div class ="comments">
                        <img class="image4" src="profile_img.webp"/>
                        <div class="author">더미 작성자 1 </div>
                        <div class="date">2021-01-01 00:00:00</div>
                        
                    </div>
                    <div class="commentcontent">
                        댓글 내용
                    </div>
                    
                </div>
                <div class = "editdelete">
                    <div class="editdelB">
                        <button onclick="openModal('edit')">수정</button>
                        <button onclick="openModal('delete')">삭제</button>
                    </div>
                </div>
            </div>
            <div class = "allcommentBox">
                <div class = "commentInfo">
                    <div class ="comments">
                        <img class="image4" src="profile_img.webp"/>
                        <div class="author" id="commentauthor">더미 작성자 1 </div>
                        <div class="date" id="commentauthor">2021-01-01 00:00:00</div>
                        
                    </div>
                    <div class="commentcontent">
                        댓글 내용
                    </div>
                    
                </div>
                <div class = "editdelete">
                    <div class="editdelB">
                        <button onclick="openModal('edit')">수정</button>
                        <button onclick="openModal('delete')">삭제</button>
                    </div>
                </div>
            </div> -->

        </article>

        <!-- 게시물 삭제 모달 -->
        <div id="deleteModal" class="deletemodal">
            <div class="modalcontent">
                <h1>게시물을 삭제하시겠습니까?</h1>
                <p1>삭제한 내용은 복구 할 수 없습니다.</p1>
                <div class="modalbutton">
                <button class="cancleButton" onclick = "closeModal()">취소</button>
                <button class="confirmButton" onclick = "confirmDelete()">확인</button>
                </div>  
            </div>
        </div>
        
        <!-- 댓글 삭제 모달 -->
        <div id="commentDeleteModal" class="deletemodal">
            <div class="modalcontent">
                <h1>댓글을 삭제하시겠습니까?</h1>
                <p1>삭제한 내용은 복구할 수 없습니다.</p1>
                <div class="modalbutton">
                    <button class="cancleButton" onclick="closeCommentDeleteModal()">취소</button>
                    <button class="confirmButton" onclick="confirmCommentDelete()">확인</button>
                </div>  
            </div>
        </div>

    </section>
</body>

<script>
// 게시물 삭제 모달 여닫는 JS 함수임
function openModal(type) {
    if (type === 'delete') {
        document.getElementById('deleteModal').style.display = 'flex';
    }
}
function closeModal() {
    document.getElementById('deleteModal').style.display = 'none';
}
function confirmDelete() {
    // 삭제 처리 코드 (예: 서버에 삭제 요청 보내기)
    closeModal(); // 모달 닫기
    alert("삭제되었습니다.");
}

// 댓글 삭제 모달 여닫는 JS 함수
function openCommentDeleteModal() {
    document.getElementById('commentDeleteModal').style.display = 'flex';
}
function closeCommentDeleteModal() {
    document.getElementById('commentDeleteModal').style.display = 'none';
}
function confirmCommentDelete() {
    // 댓글 삭제 처리 코드 (예: 서버에 삭제 요청 보내기)
    closeCommentDeleteModal(); // 모달 닫기
    alert("댓글이 삭제되었습니다.");
}

// 댓글 입력시 댓글작성 버튼 색 바뀌는 함수
// 제목, 내용 받아오기
const commentInput = document.getElementById('comment');
const commentUpButton = document.getElementById('commentUp');

// 입력 상태로 버튼 색상 바꾸기
function updateButtonState() {
    if(commentInput.value.trim() !==''){
        commentUpButton.classList.add('active');
    } else {
        commentUpButton.classList.remove('active');
    }
}
commentInput.addEventListener('input',updateButtonState);




// url에서 postid 파라미터 가져옴
const urlParams = new URLSearchParams(window.location.search);
const postid = urlParams.get('postid');




// 좋아요, 조회수, 댓글 k로 표시 함수
function formatNumber(num) {
            if (num >= 100000) {
                return Math.floor(num / 1000) + "k";  // 100k 이상
            } else if (num >= 10000) {
                return Math.floor(num / 1000) + "k";  // 10k 이상
            } else if (num >= 1000) {
                return Math.floor(num / 1000) + "k";  // 1k 이상
            }
            return num;  // 1000 미만은 그대로 표시
        }

// posts.json에서 데이터 가져오기
async function loadPostData(postid) {
    try {
        // await는 비동기 방식 (데이터 가져올 때 까지 대기)
        const response = await fetch('posts.json');
        const posts = await response.json();

        // postid에 해당하는 게시물 찾아서 post 객체에 할당
        const post = posts.find(p => p.postid == postid);

        // 해당하는 post(postid)가 존재할 때 if문 실행하기 (위에서 post 객체 null 값이면 실행 X)
        if(post) {
            // 앞의 title은 html에서 넣을 id 부분, 뒤의 post.title은 json파일에서 가져올 것
            document.getElementById('title').textContent = post.title;
            document.getElementById('author').textContent = post.author;
            document.getElementById('date').textContent = post.date;
            document.getElementById('content').textContent = post.content;

            // K 표시 적용
            document.getElementById('views').textContent = formatNumber(post.views);
            document.getElementById('likes').textContent = formatNumber(post.likes);
            document.getElementById('comments').textContent = formatNumber(post.comments);

            // 수정 버튼 누르면 postid 할당해서 넘기기. 함수
            function goToPostDetail(postid) {
                window.location.href = `edit_post.html?postid=${postid}`;
            }

            // 수정 버튼에 동적으로 클릭 이벤트를 할당
            const editButton = document.getElementById('posteditButton');
            editButton.onclick = function() {
                goToPostDetail(post.postid);  // 수정 페이지로 이동
            };
            
            // 댓글 json 넣기
            if (post && post.commentList.length > 0) {
                const allCommentBox = document.querySelector('.commentInfo');
                allCommentBox.innerHTML = '';  // 기존 댓글 지우기 (새로 추가할 때마다 초기화)

                post.commentList.forEach(comment => {
                    // 댓글 HTML 구조 쓰기
                    const commentDiv = document.createElement('div');
                    commentDiv.classList.add('commentInfo');
                    commentDiv.innerHTML = `
                        <div class="comments">
                            <img class="image4" src="profile_img.webp" />
                            <div class="author">${comment.commentauthor}</div>
                            <div class="date">${comment.commentdate}</div>
                        </div>
                        <div class="commentcontent">
                            ${comment.commentcontent}
                        </div>
                        `;

                    allCommentBox.appendChild(commentDiv);
                });

        }
        
        else {
            console.error('게시물, 댓글이 없음 찾을 수 없음 (postid 확인)');
        } 
    } else {
            console.error('게시물 없음 (postid확인)');
    }
} catch (error) {
            console.error('JSON 데이터 찾을 수 없음',error);
        }
    }

    // 페이지 로드 시 데이터 로드 함수 실행
    loadPostData(postid);

</script>